{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}LineAgeMap â€” Map{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}

{% block content %}
<div class="appFrameShell">
  <div class="appFrameCard">
    <div class="nav-family nav-family--wide">
      {% if public_slug %}
      <div class="pillTitle">PUBLIC FAMILY MAP</div>
      {% elif sample_id %}
      <div class="pillTitle">SAMPLE MAP</div>
      {% else %}
      <div class="pillTitle">MY FAMILY MAP</div>
      {% endif %}
    </div>

    <section class="mapShell" aria-label="Family Map">
      <div id="mapRoot" class="mapRoot">
        <div class="mapLegend">
          <div class="mapLegendTitle">Locations</div>
          <div class="mapLegendSub">Tap a country to zoom into regions and cities.</div>
        </div>

        <div id="mapAccordion" class="mapAccordion" aria-live="polite"></div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
{# -------------------------------------------------------------------------
Map accordion JS expects {people:[...]} so we keep using TREE endpoints.
Priority order:
1) public_slug (public tree)
2) explicit sample_id in URL
3) logged-in user => /api/tree/me
4) demo_sample (session/query chosen)
5) DEFAULT fallback stark
------------------------------------------------------------------------- #}

{% if public_slug %}
{% set MAP_API_URL = "/api/public/" ~ public_slug ~ "/tree" %}
{% elif sample_id %}
{% set MAP_API_URL = "/api/sample/" ~ sample_id ~ "/tree" %}
{% elif current_user %}
{% set MAP_API_URL = "/api/tree/me" %}
{% elif demo_sample %}
{% set MAP_API_URL = "/api/sample/" ~ demo_sample ~ "/tree" %}
{% else %}
{% set MAP_API_URL = "/api/sample/stark/tree" %}
{% endif %}

<script>
  // Data endpoint (tree-shaped payload)
  window.MAP_API_URL = "{{ MAP_API_URL }}";

  // Selected family id (used for any internal labels / debug / state)
  // Prefer sample_id, then demo_sample, else stark.
  window.MAP_FAMILY_ID = "{{ (sample_id or demo_sample or 'stark') }}";
</script>

<script>
  // IMPORTANT: map image background should match landing Migration card AND map page.
  // app.py now passes map_bg_url (resolved per selected demo sample).
  window.MAP_IMAGE_URL = "{{ map_bg_url }}";
</script>

<script type="module" src="{{ url_for('static', filename='js/map.js') }}"></script>
{% endblock %}